# 콘서트 티켓 예약을 위한 Redis 대기열 아키텍처 설계 및 구현 상세


## 성과
- 웹소켓 서버 및 스프링 서버 이중화 적용 및 Nginx를 활용한 로드밸런싱
- 웹소켓 대기 번호 조회 기능 구현
- 웹소켓 세션 관리 및 Redis Pub/Sub을 활용해 대기열->활성화열 전환 시 웹소켓 알림 시스템 구현
  - 세션 관리를 통해 웹소켓 알림 시 Exactly Once 발송 보장
- 10초마다 활성화열 인원 수를 체크하여 유동적으로 대기열 -> 활성화열 전환하여 부하 관리
- Spring Filter와 Redis를 활용한 API 트래픽 모니터링
  - 트래픽 기준 (800 이하: 대기열 Off, 1200 이상: 대기열 On) 설정
  - 트래픽 급변에 따른 ON/OFF 딜레이 3분 적용 (Debouncing)
  - Spike 트래픽 발생 시 대기열 강제 발동 적용
- 웹소켓 연결 끊김 처리 및 이탈 기준 (30초) 설정
  - 웹소켓 연결 끊김 이탈 기준 초과 시 5분 좌석 선점 예약 무효화 

## 콘서트 티켓 예약을 위한 Redis 대기열 아키텍처 설계 및 구현 상세

![image](https://github.com/user-attachments/assets/0d128f72-c37c-4ef3-8cb7-736fbb02bd97)


### (1) 웹소켓 및 스프링 서버 이중화 적용
- **서버 이중화**: 웹소켓 서버와 스프링 서버를 각각 이중화하여 트래픽 증가에 대비하고 가용성을 확보.
- **로드밸런싱**: Nginx를 활용하여 트래픽을 효율적으로 분산 처리.

### (2) 실시간 대기 번호 조회 기능
- **웹소켓 연결 및 서버 푸시**: 고객이 대기열에 진입하면 현재 대기 순번을 10초 간격으로 확인할 수 있도록 구현.

### (3) Redis Pub/Sub을 활용한 활성화열 전환 및 알림 시스템
- **확장성 확보**: Redis Pub/Sub을 통해 스프링 서버가 웹소켓 서버로 활성화열 전환 정보를 전달하여 시스템의 확장성을 확보.
- **세션 관리 및 서버 푸시**: 웹소켓 세션을 로컬 메모리에 저장하여 서버에서 클라이언트로 푸시 보장.
- **Exactly Once 보장**: 웹소켓 세션 검사를 통해 분산 웹소켓 서버 간 Exactly Once 발송 보장.

### (4) 유동적인 대기열 -> 활성화열 전환
- **실시간 트래픽 대응**: 10초마다 활성화열 인원 수를 체크하여 실시간 트래픽 변화에 대응.
- **운영 목표 설정**: 대기 시간을 30초 이내로 설정하여 최적의 대기열 운영 구현.
- **인원 제한**: 활성화열의 최대 인원 5000명으로 제한하여 트래픽 관리.
- **동시성 처리**: Redis 분산락을 통한 분산 서버간 동시성 처리 보장.
- **트랜잭션 보장**: 대기열에서 활성화열로 전환 시 Batch 방식을 활용하여 트랜잭션 보장.

### (5) Spring Filter와 Redis 기반 트래픽 모니터링 및 대기열 동적 조정
- **트래픽 모니터링**: Spring Filter와 Redis를 활용하여 API 호출별 시간과 횟수를 기록, 실시간 트래픽 모니터링.
- **대기열 On/Off**: 트래픽이 800 이하일 경우 대기열 비활성화(Off), 1200 이상일 경우 활성화(On)로 서버 부하 조절.
- **Spike 트래픽 대응**: 1500 이상의 Spike 트래픽 발생 시 대기열 자동 발동.
- **사용자 경험 개선**: 대기열 On/Off 상태가 자주 변경되지 않도록 3분의 딜레이(Debouncing) 적용.

### (6) 웹소켓 연결 끊김 처리 및 이탈 기준 설정
- **웹소켓 헬스체크**: 웹소켓 클라이언트에서 15초마다 heartbeat 데이터를 전송하여 헬스체크 데이터를 관리.
- **연결 끊김 처리**: 웹소켓 연결이 끊어진 후 30초 내 재접속이 이루어지지 않으면 자동으로 대기열 또는 활성화열에서 제거.
- **5분 좌석 선점 예약 해제**: 클라이언트 이탈 감지 시 5분 동안 유지되는 좌석 선점 예약을 해제하여 더 많은 사용자가 원활하게 예약 진행 가능.

### (7) 웹소켓 헬스체크 데이터 등 Redis 메모리 관리
- **TTL 설정**: 웹소켓 헬스체크 데이터에 TTL(Time-To-Live) 설정, 일정 시간이 지나면 자동 만료.
- **메모리 관리**: Redis 메모리를 효율적으로 관리하고, 실시간 상태 추적에 필요한 정보만 최적화된 상태로 유지.
