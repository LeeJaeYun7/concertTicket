
# MSA 기반 서비스 분리 시, Saga 패턴을 활용한 분산 트랜잭션 적용 보고서 

## 개요

이 보고서는 크게 5가지 파트로 구성됩니다.
  
**1) 상황(Situation)** <br>
**2) 작업(Task)** <br>
**3) 행동(Action)** <br>
**4) 결과(Result)** <br>
**5) 참고 자료** <br> 


<br> 
<br>


**1) 상황(Situation)** <br>

<br> 

<img src="https://github.com/user-attachments/assets/2e7b71e7-cbee-4306-ba58-84d144972884" width="50%" />


<br> 
<br> 

**(1) 모놀리식 -> MSA 전환의 필요성**

- 기존 콘서트 예약 서비스는 **모놀리식 아키텍처**로 개발되어 있었습니다. <br>
  하지만, **서비스 확장성, 서비스별 개별 배포, 서비스별 장애 격리** 등을 고려해 <br>
  이를 **MSA**(MicroServices Architecture)로의 전환을 고려하게 되었습니다.

<br> 

**(2) MSA 환경에서 트랜잭션 관리의 문제점**

- **모놀리식 환경에서 트랜잭션**은 간단하게 동작합니다. <br>
  트랜잭션을 열고, 모든 작업이 완료되면 커밋하고, <br> 
  중간에 문제가 발생하면 롤백하면 됩니다. <br>
    
- 하지만 **MSA 환경에서는 각 서비스가 독립된 DB**를 갖고 있습니다. <br>
  따라서 모놀리식 환경과 동일한 방식으로는 **트랜잭션의 ACID 보장이 어렵습니다**. <br>

<br> 

<img src="https://github.com/user-attachments/assets/c02770cb-93c7-42c6-9cf8-4bdc486e6c08" width="50%" />

- 예를 들어, MSA 환경에서 **예약- 멤버 잔액 차감 - 결제**가 순차적으로 일어나야 하는 MSA 환경에서 <br>
  결제 과정에서 에러가 발생하면 결제 DB의 트랜잭션만 롤백되는 것이 아니라 <br>
  이전 단계인 **예약 및 멤버 잔액 차감의 트랜잭션도 모두 롤백**되어야 합니다. <br>

- 따라서, MSA 환경으로 전환하려면 **분산 트랜잭션 관리가 필요**하며, <br>
  이를 통해 여러 개의 분산 트랜잭션을 하나처럼 관리하고, ACID 보장을 유지해야 했습니다. <br>  



<br> 
<br> 


**2) 작업(Task)** <br>

- MSA 환경에서 분산 트랜잭션을 관리하는 대표적인 방법은 2가지가 있습니다. <br> 
  그것은 **2PC(Two-Phase Commit) 방식과 Saga 패턴**입니다. <br>
  각각의 장단점을 비교해봤습니다. <br>

<br> 

**(1) 2PC(Two-Phase Commit)** <br> 

- **Two-Phase Commit**은 분산 트랜잭션을 처리하는데 사용되는 프로토콜로, <br>
  트랜잭션의 **성공** 또는 **실패**를 결정하는 **코디네이터**가 존재하는 접근 방식입니다. <br>
  이 프로토콜은 **두 단계**로 나눠져 있으며, 각 단계에서 코디네이터가 중요한 역할을 합니다. 

<br> 

**(1-1) 투표 단계(Voting Phase)** <br> 
<br> 
<img src="https://github.com/user-attachments/assets/9b559a3c-1bd5-4fbd-a7d5-d78be3e5c1b3" alt="Image 1" width="50%">

- 코디네이터는 각 트랜잭션 참가자에게 **커밋 가능 여부**를 질의합니다. <br>
- 각 참가자는 자신이 처리한 트랜잭션의 상태를 점검한 후, <br>
  커밋할 수 있으면 Yes를, 그렇지 않으면 No를 응답합니다. <br>

 
**(1-2) 커밋 단계(Commit Phase)** <br> 
<br>
<img src="https://github.com/user-attachments/assets/9a14741f-fd6a-408d-aefd-11f7351da2df" alt="Image 2" width="50%">

- 만약 모든 참가자가 **트랜잭션 커밋 가능**하다고 응답했을 경우에 <br>
  **코디네이터**는 커밋 요청을 보내, 트랜잭션을 **성공적으로 완료**합니다. <br>

- 하지만 **단 하나의 서비스**라도, **트랜잭션 커밋 불가**하다고 응답하거나, 트랜잭션 도중 **에러가 발생**하면, <br>
  코디네이터는 **롤백 요청**을 보내고, **트랜잭션을 전체 실패로 처리**하여 <br>
  **모든 참가자가 롤백**하도록 합니다. <br> 


